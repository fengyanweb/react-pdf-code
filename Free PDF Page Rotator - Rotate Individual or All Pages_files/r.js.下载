(()=>{var h=256,l=[],m;for(;h--;)l[h]=(h+256).toString(16).substring(1);function p(){var t=0,e,r="";if(!m||h+16>256){for(m=Array(t=256);t--;)m[t]=256*Math.random()|0;t=h=0}for(;t<16;t++)e=m[h+t],t==6?r+=l[e&15|64]:t==8?r+=l[e&63|128]:r+=l[e],t&1&&t>1&&t<11&&(r+="-");return h++,r}function g(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)t[n]=r[n]}return t}var _={read:function(t){return t[0]==='"'&&(t=t.slice(1,-1)),t.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(t){return encodeURIComponent(t).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function S(t,e){function r(o,s,i){if(!(typeof document>"u")){i=g({},e,i),typeof i.expires=="number"&&(i.expires=new Date(Date.now()+i.expires*864e5)),i.expires&&(i.expires=i.expires.toUTCString()),o=encodeURIComponent(o).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var a="";for(var c in i)i[c]&&(a+="; "+c,i[c]!==!0&&(a+="="+i[c].split(";")[0]));return document.cookie=o+"="+t.write(s,o)+a}}function n(o){if(!(typeof document>"u"||arguments.length&&!o)){for(var s=document.cookie?document.cookie.split("; "):[],i={},a=0;a<s.length;a++){var c=s[a].split("="),E=c.slice(1).join("=");try{var I=decodeURIComponent(c[0]);if(i[I]=t.read(E,I),o===I)break}catch{}}return o?i[o]:i}}return Object.create({set:r,get:n,remove:function(o,s){r(o,"",g({},s,{expires:-1}))},withAttributes:function(o){return S(this.converter,g({},this.attributes,o))},withConverter:function(o){return S(g({},this.converter,o),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(t)}})}var f=S(_,{path:"/"});var x=f.withAttributes({expires:365,sameSite:"Lax",path:"/"});function R(t){let e=o=>{try{return new URL(o)}catch{return}},r=o=>{let s=o.hostname.split("."),i=s[s.length-1],a=[];if(s.length===4&&parseInt(i,10)>0||s.length<=1)return a;for(let c=s.length-2;c>=0;--c)a.push(s.slice(c).join("."));return a},n=e(t);if(n){let o=r(n);for(let s=0;s<o.length;++s){let i="rg_test_cookie",a=o[s];try{if(x.set(i,"1",{domain:a}),x.get(i)==="1")return x.remove(i,{domain:a}),a}catch{return}}}}var u=class{static#e=f.withAttributes({expires:365,sameSite:"Lax",domain:R(window.location.href),path:"/"});static get domain(){return this.#e.attributes.domain}static set(e,r){this.#e.set(e,r),localStorage.setItem(e,r)}static get(e){return localStorage.getItem(e)||this.#e.get(e)||null}static remove(e){this.#e.remove(e),localStorage.removeItem(e)}};var L=t=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t),U=t=>{try{return JSON.parse(localStorage.getItem(t)||"{}")}catch(e){return console.error(`[RevGems] Error loading ${t}: ${e.message}`),console.error(`[RevGems] Removing ${t} from localStorage`),localStorage.removeItem(t),{}}},v=class{#e;#o;#t=null;#s={};constructor(e,r){this.#e=e,this.#o=r,this.id=u.get(this.#e),this.#s=U(this.#o)}reset(){this.id=this.properties=null}set id(e){this.#t=e,L(this.#t)&&console.warn("[RevGems]","Do not use email addresses for ID parameters."),e?u.set(this.#e,e):u.remove(this.#e)}get id(){return this.#t}get properties(){return this.#s}set properties(e){if(e===null)this.#s={},localStorage.removeItem(this.#o);else if(Object.getPrototypeOf(e)===Object.prototype)this.#s=e,localStorage.setItem(this.#o,JSON.stringify(this.#s));else throw new Error("properties must be an object or null.")}},w=class t extends v{static#e="revgems_anonymous_id";#o=null;#t=null;constructor({anonymousId:e,hash:r}={}){super("revgems_account_id","revgems_account_properties"),this.anonymousId=e||u.get(t.#e)||p(),this.#t=r}set anonymousId(e){this.#o=e,u.set(t.#e,e)}get anonymousId(){return this.#o}get hash(){return this.#t}},y=class extends v{constructor(){super("revgems_user_id","revgems_user_properties")}};var O=(t,e)=>{let r=new URLSearchParams(t.search.substring(1));Object.keys(e).forEach(n=>r.set(n,e[n])),t.search=r.toString()},C=createCrossDomainLinks=(t,e,r)=>{let n=e.filter(s=>s!==t).map(s=>`a[href*="${s}"]:not(a[href*="revgems-anonymous-id=${r}"])`).join(", "),o;document.querySelectorAll(n).forEach(s=>{try{o=new URL(s.href),o.hostname!==t&&!o.hostname.endsWith(`.${t}`)&&O(s,{"revgems-anonymous-id":r})}catch(i){console.error(`[RevGems] Error processing link: ${s.href}`,i)}})};var d=class{#e;#o;#t;#s;#r;#n;#i={title:document.title,referrer:document.referrer,url:document.location.href};constructor({pushKey:e,debug:r=!1,domains:n=[],endpoint:o="https://t.revgems.com/",anonymousId:s,accountHash:i}={}){this.#e=e,this.#o=!!r,this.#t=n,this.#n=new URL(o),this.#n.pathname="messages",this.#r=new w({anonymousId:s,hash:i}),this.#s=new y,this.log("Instantiated",{pushKey:this.#e,endpoint:this.#n.toString(),domains:this.#t,"Storage.domain":u.domain})}ready(e){typeof e=="function"&&(this.log("Executing ready() handler"),e())}crossDomain(){this.#t.length&&(this.log("Creating cross-domain links"),C(u.domain,this.#t,this.#r.anonymousId))}log(){this.#o&&console.debug("[RevGems]",...arguments)}trackPageView({occurredAt:e=new Date,title:r=document.title,referrer:n=document.referrer,url:o=document.location.href,...s}={}){return this.#i={title:r,referrer:n,url:o},this.crossDomain(),this.#a({type:"page",occurredAt:e,properties:{...this.#i,...s}})}convertToLead(e){return e?this.#r.id=e:console.warn("RevGems.convertToLead() missing recommended parameter `accountId`"),this.#a({type:"lead"})}user(e,r={}){if(e)return this.#c("user",this.#s,e,r);console.error("User `id` argument is required.")}account(e,r={}){if(e)return this.#c("account",this.#r,e,r);console.error("Account `id` argument is required.")}logout(){let e=this.#r.anonymousId;this.reset(),this.#r.anonymousId=e}reset(){this.#s.reset(),this.#r.reset()}#c(e,r,n,o={}){return r.id=n,r.properties={...r.properties,...o},this.#a({type:e,properties:r.properties})}get anonymousId(){return this.#r.anonymousId}#u(e){return e.occurredAt||=new Date,{...e,messageId:p(),pushKey:this.#e,anonymousId:this.#r.anonymousId,userId:this.#s.id,accountHash:this.#r.hash,accountId:this.#r.id,context:{page:this.#i,userAgent:navigator.userAgent,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,locale:navigator.language}}}#a(e){let r=n=>({success:!1,errors:n.errors||[n.message]});return e=this.#u(e),e.sentAt=new Date,this.log("sendMessage: ",e),fetch(this.#n,{method:"POST",keepalive:!0,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(n=>n.json().then(o=>n.ok?o:r(o)).catch(r)).catch(r)}};var D=processQueue=t=>{let e=window[window._rg].q||JSON.parse(window.localStorage.getItem("revgems_queue")||"[]"),r=(o,s)=>t[o].apply(t,s),n;for(;e.length;)n=Array.prototype.slice.call(e.shift()),r(n[0],n.slice(1));window.localStorage.setItem("revgems_queue","[]"),window[window._rg]=(...o)=>r(o[0],o.slice(1))};(()=>{if(window._revgemsLoaded){console.warn("RevGems is already loaded. Ensure the script tag appears on the page only once.");return}let t=window.REVGEMS_CONFIG||{};if(!t.pushKey){console.error("Missing or invalid RevGems Push API Key.");return}let e=new URLSearchParams(window.location.search);e.has("revgems-debug")&&(t.debug=!0),t.anonymousId=e.get("revgems-anonymous-id");let r=new d(t);window.RevGems=r,window._revgemsLoaded=!0;let n,o=0;document.addEventListener("turbo:load",()=>{o>0&&r.trackPageView({referrer:n}),o++}),document.addEventListener("turbo:visit",()=>{n=document.location.href}),D(r)})();})();
